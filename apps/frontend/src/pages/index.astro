---
import Layout from '../layouts/Layout.astro';

type CmsItem = {
	title: string;
	link: string;
	category: string;
	date: string;
};

const cmsBaseUrls = [import.meta.env.PUBLIC_CMS_URL, 'http://cms:3000', 'http://localhost:3000'].filter(
	Boolean
) as string[];

async function fetchNewItems(): Promise<CmsItem[]> {
	const endpoints = [
		'/api/pages?limit=6&depth=1&sort=-updatedAt&where[isNew][equals]=true'
	];

	for (const baseUrl of cmsBaseUrls) {
		for (const endpoint of endpoints) {
			try {
				const res = await fetch(`${baseUrl}${endpoint}`);
				if (!res.ok) continue;

				const data = await res.json();
				if (!data?.docs || !Array.isArray(data.docs)) continue;

				return data.docs.slice(0, 6).map((doc: any) => ({
					title: doc.title || doc.name || doc.slug || 'Untitled',
					link: `/review?slug=${encodeURIComponent(doc.slug || doc.id || '')}`,
					category: doc.category?.title || doc.category || 'General',
					date: doc.updatedAt || doc.createdAt || new Date().toISOString()
				}));
			} catch (_) {
				// Try next endpoint/base URL.
			}
		}
	}

	return [];
}

const newItems = await fetchNewItems();
const fallbackItems: CmsItem[] = [
	{
		title: 'Magnesium Glycinate: Sleep and Recovery Notes',
		link: '#',
		category: 'Supplements',
		date: '2026-02-20'
	},
	{
		title: 'Olive Oil Deep Dive: Polyphenols and Heat Stability',
		link: '#',
		category: 'Foods',
		date: '2026-02-18'
	},
	{
		title: 'High-Protein Mediterranean Diet Review',
		link: '#',
		category: 'Diets',
		date: '2026-02-14'
	}
];
---

<Layout title="MetStat" description="Personal health wiki for structured reviews and study notes.">
	<div class="page-shell">
		<header class="site-header">
			<div class="brand-row">
				<div class="brand">MetStat</div>
				<button
					class="menu-toggle"
					type="button"
					aria-expanded="false"
					aria-controls="primary-nav"
					aria-label="Toggle navigation menu"
				>
					<span class="menu-bars" aria-hidden="true"></span>
					<span class="menu-label">Menu</span>
				</button>
			</div>
			<nav class="mega-nav" id="primary-nav" aria-label="Main">
				<ul>
					<li class="with-panel">
						<button type="button">Reviews</button>
						<div class="panel">
							<div>
								<h3>Foods</h3>
								<a href="#">Whole Foods</a>
								<a href="#">Meal Components</a>
								<a href="#">Brand Comparisons</a>
							</div>
							<div>
								<h3>Supplements</h3>
								<a href="#">Evidence Grading</a>
								<a href="#">Dosing Notes</a>
								<a href="#">Safety Flags</a>
							</div>
							<div>
								<h3>Diets</h3>
								<a href="#">Diet Protocols</a>
								<a href="#">Compliance Guides</a>
								<a href="#">Outcome Tracking</a>
							</div>
						</div>
					</li>
					<li class="with-panel">
						<button type="button">Research</button>
						<div class="panel">
							<div>
								<h3>Studies</h3>
								<a href="#">RCTs</a>
								<a href="#">Meta-Analyses</a>
								<a href="#">Mechanistic Papers</a>
							</div>
							<div>
								<h3>Methods</h3>
								<a href="#">Bias Checklist</a>
								<a href="#">Endpoints</a>
								<a href="#">Sample Quality</a>
							</div>
							<div>
								<h3>Templates</h3>
								<a href="#">Study Summary</a>
								<a href="#">Risk/Benefit Matrix</a>
								<a href="#">Claim Verifier</a>
							</div>
						</div>
					</li>
					<li><a href="#new">New</a></li>
					<li><a href="#">About</a></li>
				</ul>
			</nav>
		</header>

		<main>
			<section class="hero block">
				<div class="block-text hero-content">
					<p class="eyebrow">PERSONAL KNOWLEDGE SYSTEM</p>
					<h1>One place to review foods, supplements, diets, and studies.</h1>
					<p class="lede">
						Structured like a personal Wikipedia: each topic has summary notes, evidence quality, practical
						use, and links to deeper review pages.
					</p>
				</div>
			</section>

			<section class="block flow-block" aria-label="Foods section">
				<div class="block-text">
					<p class="eyebrow">FOODS</p>
					<h2>Ingredient-level notes with practical context.</h2>
					<p>
						Track ingredient quality, prep techniques, and when a food is useful or overhyped. Keep each entry
						anchored in outcome-based thinking rather than trends.
					</p>
					<p>
						Build references for common pantry staples, restaurant patterns, and meal components you use often,
						so review notes can support actual day-to-day decisions.
					</p>
				</div>
				<div class="image-slot" role="img" aria-label="Foods image placeholder">
					<span>Foods Image Slot</span>
				</div>
			</section>

			<section class="block flow-block reverse" aria-label="Supplements section">
				<div class="block-text">
					<p class="eyebrow">SUPPLEMENTS</p>
					<h2>Dose windows, benefit claims, and risk tracking.</h2>
					<p>
						Document what claims are supported, where evidence is weak, and which combinations need caution.
						Keep practical recommendations tied to population and use case.
					</p>
					<p>
						Capture timing guidance, interaction notes, and confidence ratings to quickly compare options before
						adding anything to a routine.
					</p>
				</div>
				<div class="image-slot" role="img" aria-label="Supplements image placeholder">
					<span>Supplements Image Slot</span>
				</div>
			</section>

			<section class="block flow-block" aria-label="Diets section">
				<div class="block-text">
					<p class="eyebrow">DIETS</p>
					<h2>Framework comparisons and sustainability notes.</h2>
					<p>
						Compare protocol goals, adherence burden, and likely outcomes for different populations. Treat each
						diet as a tool with constraints instead of a universal answer.
					</p>
					<p>
						Keep short summaries and long-form notes side-by-side so you can scan quickly or dig deeper when
						needed.
					</p>
				</div>
				<div class="image-slot" role="img" aria-label="Diets image placeholder">
					<span>Diets Image Slot</span>
				</div>
			</section>

			<section class="block narrative">
				<div class="intro">
					<p class="eyebrow">RESEARCH WORKFLOW</p>
					<h2>From study to decision in one page flow.</h2>
				</div>
				<div class="steps">
					<article>
						<h3>1. Capture</h3>
						<p>Save the core finding and paper context while it is still fresh.</p>
					</article>
					<article>
						<h3>2. Grade</h3>
						<p>Score quality and assign confidence before writing recommendations.</p>
					</article>
					<article>
						<h3>3. Apply</h3>
						<p>Translate evidence into concrete daily actions and constraints.</p>
					</article>
				</div>
				<div class="image-strip" aria-label="Research image placeholders">
					<div class="image-slot"><span>Study Figure Slot</span></div>
					<div class="image-slot"><span>Methods Diagram Slot</span></div>
					<div class="image-slot"><span>Outcome Chart Slot</span></div>
				</div>
			</section>

			<section id="new" class="new-section block">
				<div class="new-header">
					<h2>New</h2>
					<p>Latest entries</p>
				</div>
				<div class="new-list">
					{(newItems.length ? newItems : fallbackItems).map((item) => (
						<a class="new-item" href={item.link}>
							<span class="tag">{item.category}</span>
							<strong>{item.title}</strong>
							<time datetime={item.date}>{new Date(item.date).toLocaleDateString()}</time>
						</a>
					))}
				</div>
			</section>

			<section class="block outro">
				<div class="outro-text">
					<p class="eyebrow">BUILD AS YOU GO</p>
					<h2>Keep adding pages, visuals, and references over time.</h2>
					<p>
						Use this homepage as a long-form map: each block can expand, each image slot can become a figure,
						and each summary can link to detailed pages.
					</p>
				</div>
				<div class="image-slot image-tall" role="img" aria-label="Final image placeholder">
					<span>Feature Image Slot</span>
				</div>
			</section>
		</main>
	</div>
</Layout>

<script>
	const header = document.querySelector('.site-header');
	const toggle = document.querySelector('.menu-toggle');

	if (header && toggle) {
		toggle.addEventListener('click', () => {
			const open = header.classList.toggle('menu-open');
			toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
		});

		window.addEventListener('resize', () => {
			if (window.innerWidth > 760 && header.classList.contains('menu-open')) {
				header.classList.remove('menu-open');
				toggle.setAttribute('aria-expanded', 'false');
			}
		});
	}
</script>

<style>
	:root {
		--ink: #162130;
		--muted: #586778;
		--paper: #f5f2e9;
		--card: #fffdf8;
		--accent: #f26430;
		--accent-2: #1f8a70;
		--line: #e5ddcc;
	}

	body {
		margin: 0;
		overflow-x: hidden;
		background:
			radial-gradient(circle at 0% 0%, rgba(242, 100, 48, 0.18), transparent 45%),
			radial-gradient(circle at 100% 10%, rgba(31, 138, 112, 0.2), transparent 42%),
			var(--paper);
		color: var(--ink);
	}

	.page-shell {
		width: 100%;
		max-width: none;
		margin: 0;
		padding: 0 0 3rem;
		overflow-x: clip;
	}

	.site-header {
		display: flex;
		flex-direction: column;
		align-items: stretch;
		justify-content: space-between;
		gap: 1rem;
		border: 1px solid var(--line);
		background: rgba(255, 253, 248, 0.9);
		backdrop-filter: blur(4px);
		padding: 0.8rem 1rem;
		border-radius: 0;
		position: sticky;
		top: 0;
		z-index: 10;
		width: 100%;
		box-sizing: border-box;
	}

	.brand-row {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.75rem;
		width: 100%;
	}

	.brand {
		font-family: 'Book Antiqua', Palatino, 'Palatino Linotype', serif;
		font-size: 1.2rem;
		letter-spacing: 0.02em;
	}

	.menu-toggle {
		display: none;
		border: 1px solid var(--line);
		background: var(--card);
		color: var(--ink);
		padding: 0.45rem 0.7rem;
		font: inherit;
		align-items: center;
		gap: 0.5rem;
		cursor: pointer;
	}

	.menu-bars {
		display: inline-block;
		width: 1rem;
		height: 2px;
		background: currentColor;
		position: relative;
	}

	.menu-bars::before,
	.menu-bars::after {
		content: '';
		position: absolute;
		left: 0;
		width: 1rem;
		height: 2px;
		background: currentColor;
	}

	.menu-bars::before {
		top: -0.32rem;
	}

	.menu-bars::after {
		top: 0.32rem;
	}

	.menu-label {
		font-size: 0.9rem;
	}

	.mega-nav ul {
		display: flex;
		align-items: center;
		list-style: none;
		margin: 0;
		padding: 0;
		gap: 0.2rem;
	}

	.mega-nav a,
	.mega-nav button {
		text-decoration: none;
		border: 0;
		background: transparent;
		color: var(--ink);
		font: inherit;
		padding: 0.55rem 0.85rem;
		border-radius: 0;
		cursor: pointer;
	}

	.mega-nav a:hover,
	.mega-nav button:hover {
		background: #ece7da;
	}

	.with-panel {
		position: relative;
	}

	.panel {
		position: absolute;
		top: calc(100% + 0.5rem);
		right: 0;
		display: grid;
		grid-template-columns: repeat(3, minmax(160px, 1fr));
		gap: 1rem;
		padding: 1rem;
		background: var(--card);
		border: 1px solid var(--line);
		border-radius: 0;
		box-shadow: 0 14px 30px rgba(14, 25, 39, 0.12);
		min-width: 540px;
		max-width: min(92vw, 720px);
		opacity: 0;
		pointer-events: none;
		transform: translateY(-8px);
		transition: opacity 200ms ease, transform 200ms ease;
	}

	.with-panel:hover .panel,
	.with-panel:focus-within .panel {
		opacity: 1;
		pointer-events: auto;
		transform: translateY(0);
	}

	.panel h3 {
		margin: 0 0 0.45rem;
		font-size: 0.9rem;
		color: var(--accent-2);
		letter-spacing: 0.03em;
	}

	.panel a {
		display: block;
		padding: 0.3rem 0;
		font-size: 0.92rem;
		color: var(--muted);
	}

	.panel a:hover {
		color: var(--ink);
		background: transparent;
	}

	main {
		padding-top: 2rem;
		padding-inline: 1rem;
		display: grid;
		gap: 1.35rem;
	}

	.hero {
		position: relative;
		min-height: clamp(420px, 75vh, 760px);
		display: flex;
		align-items: flex-end;
		padding: clamp(1.2rem, 4vw, 2.4rem);
		animation: fade-slide 500ms ease both;
		overflow: hidden;
	}

	.hero::before {
		content: '';
		position: absolute;
		inset: 0;
		z-index: 0;
		background-image:
			linear-gradient(to top, rgba(8, 18, 29, 0.78) 0%, rgba(8, 18, 29, 0.4) 38%, rgba(8, 18, 29, 0.22) 100%),
			url('/hero-health.jpg');
		background-size: cover;
		background-position: center;
		background-repeat: no-repeat;
		background-attachment: fixed;
		transform: scale(1.06);
	}

	.hero-content {
		position: relative;
		z-index: 1;
		max-width: min(900px, 100%);
	}

	.hero .eyebrow {
		color: #cfe4dc;
	}

	.hero h1 {
		color: #f7fbff;
		max-width: 13ch;
		text-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
	}

	.hero .lede {
		color: #e4edf5;
		max-width: 56ch;
	}

	.block {
		border: 1px solid var(--line);
		border-radius: 0;
		background: rgba(255, 253, 248, 0.8);
	}

	.flow-block,
	.outro {
		display: grid;
		grid-template-columns: 1.15fr 0.85fr;
		gap: 1rem;
		align-items: stretch;
		padding: 1.1rem;
	}

	.flow-block.reverse {
		grid-template-columns: 0.85fr 1.15fr;
	}

	.flow-block.reverse .block-text {
		order: 2;
	}

	.flow-block.reverse .image-slot {
		order: 1;
	}

	.eyebrow {
		margin: 0 0 0.35rem;
		font-size: 0.72rem;
		letter-spacing: 0.18em;
		color: var(--accent-2);
		font-weight: 700;
	}

	h1 {
		font-family: 'Book Antiqua', Palatino, 'Palatino Linotype', serif;
		font-size: clamp(2rem, 5.8vw, 3.6rem);
		line-height: 1.05;
		margin: 0;
		max-width: 15ch;
	}

	.lede {
		font-size: 1.05rem;
		color: var(--muted);
		max-width: 62ch;
		margin-top: 0.9rem;
	}

	.block-text p {
		color: var(--muted);
		line-height: 1.6;
	}

	.block-text h2 {
		font-family: 'Book Antiqua', Palatino, 'Palatino Linotype', serif;
		font-size: clamp(1.45rem, 3.8vw, 2.4rem);
		margin: 0;
		max-width: 18ch;
	}

	.image-slot {
		border-radius: 0;
		border: 1px dashed #cdbf9f;
		min-height: 210px;
		background:
			linear-gradient(135deg, rgba(31, 138, 112, 0.12), rgba(242, 100, 48, 0.1)),
			repeating-linear-gradient(
				-45deg,
				rgba(255, 255, 255, 0.55),
				rgba(255, 255, 255, 0.55) 10px,
				rgba(236, 231, 218, 0.45) 10px,
				rgba(236, 231, 218, 0.45) 20px
			);
		display: grid;
		place-items: center;
		padding: 1rem;
		text-align: center;
		color: #465467;
		font-weight: 700;
		letter-spacing: 0.03em;
	}

	.image-tall {
		min-height: 340px;
	}

	.new-section {
		padding: 1rem;
	}

	.new-header h2 {
		margin: 0;
		font-size: 1.25rem;
	}

	.new-header p {
		margin: 0.35rem 0 0;
		color: var(--muted);
		font-size: 0.92rem;
	}

	.new-list {
		margin-top: 1rem;
		display: grid;
		grid-template-columns: repeat(3, minmax(0, 1fr));
		gap: 0.75rem;
	}

	.new-item {
		text-decoration: none;
		color: inherit;
		display: flex;
		flex-direction: column;
		gap: 0.45rem;
		padding: 0.8rem;
		border: 1px solid var(--line);
		border-radius: 0;
		background: var(--card);
		min-height: 130px;
	}

	.narrative {
		padding: 1.2rem;
	}

	.narrative .intro h2 {
		margin: 0;
		font-family: 'Book Antiqua', Palatino, 'Palatino Linotype', serif;
		font-size: clamp(1.35rem, 3vw, 2rem);
	}

	.steps {
		margin-top: 1rem;
		display: grid;
		grid-template-columns: repeat(3, minmax(0, 1fr));
		gap: 0.75rem;
	}

	.steps article {
		border: 1px solid var(--line);
		border-radius: 0;
		padding: 0.85rem;
		background: var(--card);
	}

	.steps h3 {
		margin: 0;
		font-size: 0.96rem;
	}

	.steps p {
		margin: 0.5rem 0 0;
		color: var(--muted);
		font-size: 0.92rem;
	}

	.image-strip {
		margin-top: 0.9rem;
		display: grid;
		grid-template-columns: repeat(3, minmax(0, 1fr));
		gap: 0.75rem;
	}

	.outro {
		padding: 1.2rem;
	}

	.outro-text h2 {
		margin: 0;
		font-family: 'Book Antiqua', Palatino, 'Palatino Linotype', serif;
		font-size: clamp(1.35rem, 3vw, 2rem);
	}

	.outro-text p {
		color: var(--muted);
	}

	.new-item strong {
		line-height: 1.35;
	}

	.tag {
		font-size: 0.73rem;
		color: var(--accent);
		letter-spacing: 0.06em;
		text-transform: uppercase;
		font-weight: 700;
	}

	time {
		color: var(--muted);
		font-size: 0.78rem;
		margin-top: auto;
	}

	@keyframes fade-slide {
		from {
			opacity: 0;
			transform: translateY(12px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@media (max-width: 940px) {
		.flow-block,
		.flow-block.reverse,
		.outro {
			grid-template-columns: 1fr;
		}

		.flow-block.reverse .block-text,
		.flow-block.reverse .image-slot {
			order: initial;
		}

		.steps,
		.image-strip {
			grid-template-columns: 1fr;
		}

		.new-list {
			grid-template-columns: 1fr;
		}

		.panel {
			min-width: min(92vw, 460px);
		}
	}

	@media (max-width: 760px) {
		.hero::before {
			background-attachment: scroll;
		}

		.menu-toggle {
			display: inline-flex;
		}

		.mega-nav {
			max-height: 0;
			opacity: 0;
			overflow: hidden;
			pointer-events: none;
			transition: max-height 240ms ease, opacity 240ms ease;
		}

		.site-header.menu-open .mega-nav {
			max-height: 70vh;
			opacity: 1;
			pointer-events: auto;
			overflow-y: auto;
		}

		.mega-nav ul {
			flex-direction: column;
			align-items: stretch;
			gap: 0;
		}

		.mega-nav a,
		.mega-nav button {
			width: 100%;
			text-align: left;
			padding-inline: 0.4rem;
		}

		.panel {
			left: 0;
			right: auto;
			grid-template-columns: 1fr;
			min-width: min(90vw, 320px);
		}
	}
</style>
